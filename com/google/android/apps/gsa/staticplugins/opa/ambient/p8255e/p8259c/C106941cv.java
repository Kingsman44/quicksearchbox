package com.google.android.apps.gsa.staticplugins.opa.ambient.p8255e.p8259c;

import android.content.Context;
import android.content.Intent;
import android.media.AudioManager;
import android.provider.Settings;
import com.evernote.android.state.BuildConfig;
import com.google.android.apps.gsa.opa.p6429a.p6431b.C83564a;
import com.google.android.apps.gsa.opa.smartspace.C83807w;
import com.google.android.apps.gsa.opa.smartspace.p6454c.C83751g;
import com.google.android.apps.gsa.p8839t.p8840a.C118339a;
import com.google.android.apps.gsa.p8852u.C118569b;
import com.google.android.apps.gsa.shared.p7066m.C90017bw;
import com.google.android.apps.gsa.shared.p7066m.C90021c;
import com.google.android.apps.gsa.smartspace.p7257a.C92028j;
import com.google.android.apps.gsa.smartspace.p7257a.C92030l;
import com.google.android.apps.gsa.staticplugins.opa.ambient.core.p8245c.C106729a;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8207b.C106595g;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8207b.C106596h;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8207b.p8213d.p8217d.C106531e;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8255e.C106864c;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8255e.C107016e;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8255e.C107017f;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8264h.p8272f.C107060a;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8274i.p8275a.C107079a;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8274i.p8275a.C107080b;
import com.google.android.apps.gsa.staticplugins.opa.ambient.p8274i.p8275a.C107081c;
import com.google.android.apps.search.assistant.platform.pcp.p9329f.C123728av;
import com.google.android.apps.search.assistant.verticals.ambient.p9937n.p9942c.C131090m;
import com.google.android.googlequicksearchbox.R;
import com.google.android.libraries.assistant.pcp.p1573k.C18929i;
import com.google.android.libraries.search.logging.p3041d.C39141kp;
import com.google.apps.tiktok.tracing.contrib.p3700b.C47633f;
import com.google.apps.tiktok.tracing.contrib.p3700b.C47636i;
import com.google.assistant.p3803ag.p3809c.C49156z;
import com.google.assistant.p3886c.C50692ad;
import com.google.assistant.p3886c.C50693ae;
import com.google.assistant.p3886c.C50701am;
import com.google.assistant.p3886c.C50702an;
import com.google.assistant.p3886c.C50705aq;
import com.google.assistant.p3886c.C50706ar;
import com.google.assistant.p3886c.C50710av;
import com.google.assistant.p3886c.C50738bc;
import com.google.assistant.p3886c.C50785ci;
import com.google.assistant.p3886c.C50790cn;
import com.google.assistant.p3886c.C50794cr;
import com.google.assistant.p3886c.C50818do;
import com.google.assistant.p3886c.C50819dp;
import com.google.assistant.p3886c.p3887a.C50671g;
import com.google.assistant.p3886c.p3887a.C50672h;
import com.google.common.p4522b.C58370cn;
import com.google.common.p4522b.C58485gu;
import com.google.common.p4526f.C58976aa;
import com.google.common.p4526f.p4527a.C58970a;
import com.google.common.p4526f.p4527a.C58974d;
import com.google.common.p4526f.p4527a.C58975e;
import com.google.common.p4580v.C60950i;
import com.google.common.util.concurrent.C60826bg;
import com.google.common.util.concurrent.C60856cj;
import com.google.common.util.concurrent.C60870cx;
import com.google.common.util.concurrent.C60888db;
import com.google.protobuf.C62940bt;
import java.io.Serializable;
import java.util.Locale;
import java.util.concurrent.ExecutionException;
import p3186j$.time.Duration;
import p3186j$.time.Instant;
import p3186j$.util.Collection;
import p3186j$.util.Optional;

/* renamed from: com.google.android.apps.gsa.staticplugins.opa.ambient.e.c.cv */
/* compiled from: PG */
public final class C106941cv implements C106864c {

    /* renamed from: h */
    public static final /* synthetic */ int f297871h = 0;

    /* renamed from: i */
    private static final C50701am f297872i = C50701am.HEADPHONE_CONTEXT;

    /* renamed from: a */
    public final C58974d f297873a;

    /* renamed from: b */
    public final C90021c f297874b;

    /* renamed from: c */
    public final C118339a f297875c;

    /* renamed from: d */
    public final C60950i f297876d;

    /* renamed from: e */
    public final C106879an f297877e;

    /* renamed from: f */
    public final C83751g f297878f;

    /* renamed from: g */
    public final C39141kp f297879g;

    /* renamed from: j */
    private final Context f297880j;

    /* renamed from: k */
    private final C106959m f297881k;

    /* renamed from: l */
    private final C60888db f297882l;

    /* renamed from: m */
    private final C107060a f297883m;

    /* renamed from: n */
    private final C83807w f297884n;

    /* renamed from: o */
    private final C106867ab f297885o;

    /* renamed from: p */
    private final C106924ce f297886p;

    /* renamed from: q */
    private final C106729a f297887q;

    /* renamed from: r */
    private final C92030l f297888r;

    public C106941cv(Context context, C118339a aVar, C106959m mVar, C60888db dbVar, C90021c cVar, C107060a aVar2, C83564a aVar3, C83807w wVar, C106879an anVar, C106867ab abVar, C60950i iVar, C106924ce ceVar, C83751g gVar, C106729a aVar4, C39141kp kpVar, C92030l lVar) {
        this.f297880j = context;
        this.f297875c = aVar;
        this.f297881k = mVar;
        this.f297882l = dbVar;
        this.f297874b = cVar;
        this.f297883m = aVar2;
        C83564a aVar5 = aVar3;
        this.f297873a = aVar3.mo76900a("MediaRecsCtxProducer");
        this.f297884n = wVar;
        this.f297876d = iVar;
        this.f297877e = anVar;
        this.f297885o = abVar;
        this.f297886p = ceVar;
        this.f297878f = gVar;
        this.f297887q = aVar4;
        this.f297879g = kpVar;
        this.f297888r = lVar;
    }

    /* renamed from: h */
    private static String m177658h(C106596h hVar) {
        return String.format(Locale.getDefault(), "%s-%d", new Object[]{f297872i.name(), Long.valueOf(hVar.f297211f)});
    }

    /* renamed from: a */
    public final boolean mo95696a(C106596h hVar) {
        if (!this.f297874b.mo79746e(C90017bw.f247937az)) {
            ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23422)).mo56386p("#shouldHandleContext(): Media recommendation is not enabled. Not handling...");
            return false;
        } else if (Settings.Secure.getInt(this.f297880j.getContentResolver(), "qs_media_recommend", 1) != 0) {
            AudioManager audioManager = (AudioManager) this.f297880j.getSystemService("audio");
            if (audioManager == null || !(audioManager.isMusicActive() || audioManager.getMode() == 2 || audioManager.getMode() == 3)) {
                if (m177658h(hVar).equals(this.f297887q.mo95629a().mo56109e(BuildConfig.FLAVOR))) {
                    ((C58970a) ((C58970a) this.f297873a.mo56226d()).mo56372aa(23419)).mo56386p("#shouldHandleContext(): Headphone connection event already handled.");
                    return false;
                } else if (this.f297878f.mo77082f() || !hVar.f297208c) {
                    boolean z = hVar.f297208c;
                    C106595g a = C106595g.m177369a(hVar.f297218m);
                    if (a == null) {
                        a = C106595g.UNSPECIFIED;
                    }
                    int i = a.f297203i;
                    C106531e a2 = C106531e.m177306a(hVar.f297207b);
                    if (a2 == null) {
                        a2 = C106531e.UNKNOWN;
                    }
                    if (a2 == C106531e.CAR_BLUETOOTH) {
                        ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23417)).mo56386p("#shouldHandleContext(): Car bluetooth is connected. Exit");
                        return false;
                    }
                    C106595g gVar = C106595g.HEADSET_STATE;
                    C106595g a3 = C106595g.m177369a(hVar.f297218m);
                    if (a3 == null) {
                        a3 = C106595g.UNSPECIFIED;
                    }
                    boolean equals = gVar.equals(a3);
                    boolean e = this.f297874b.mo79746e(C90017bw.f247890aE);
                    boolean e2 = this.f297874b.mo79746e(C90017bw.f247888aC);
                    if (e && equals) {
                        ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23416)).mo56386p("#shouldHandleContext(): Bypassing content store, all headset states are handled.");
                        return true;
                    } else if (e2) {
                        return hVar.f297208c;
                    } else {
                        if (!equals || !hVar.f297208c) {
                            return false;
                        }
                        return true;
                    }
                } else {
                    ((C58970a) ((C58970a) this.f297873a.mo56226d()).mo56372aa(23418)).mo56386p("#shouldHandleContext(): Not handling event during reset.");
                    return false;
                }
            }
            return false;
        } else {
            ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23421)).mo56386p("#shouldHandleContext(): Media recommendation setting is disabled. Not handling...");
            return false;
        }
    }

    /* renamed from: b */
    public final C50701am mo95697b() {
        return C50701am.HEADPHONE_CONTEXT;
    }

    /* renamed from: c */
    public final C60870cx mo95698c(C106596h hVar) {
        C60870cx cxVar;
        C60870cx cxVar2;
        C60870cx cxVar3;
        C60870cx cxVar4;
        if (!hVar.f297208c) {
            if (this.f297874b.mo79746e(C90017bw.f247890aE)) {
                C106595g gVar = C106595g.HEADSET_STATE;
                C106595g a = C106595g.m177369a(hVar.f297218m);
                if (a == null) {
                    a = C106595g.UNSPECIFIED;
                }
                if (gVar.equals(a)) {
                    ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23408)).mo56386p("#generateSuggestions: Handling disconnection. Generating empty card");
                    C107016e d = C107017f.m177726d();
                    C50785ci ciVar = (C50785ci) C50819dp.f132330b.createBuilder();
                    C50790cn cnVar = (C50790cn) C50818do.f132293H.createBuilder();
                    C50794cr crVar = C50794cr.UNDEFINED;
                    cnVar.copyOnWrite();
                    C50818do doVar = (C50818do) cnVar.instance;
                    doVar.f132315l = crVar.f132222T;
                    doVar.f132304a |= 1024;
                    ciVar.mo53457b(cnVar);
                    d.mo95687c(Optional.m71637of((C50819dp) ciVar.build()));
                    return C60856cj.m92900i(d.mo95685a());
                }
            }
            return C60856cj.m92900i(C107017f.m177726d().mo95685a());
        }
        this.f297878f.mo77077a("3/9: Starts to generate media suggestions.");
        Optional empty = Optional.empty();
        if (this.f297874b.mo79746e(C90017bw.f247887aB)) {
            empty = Optional.m71637of(this.f297876d.mo57444a());
        }
        C92030l lVar = this.f297888r;
        C47633f h = C47633f.m84733g(lVar.f256564a.mo46042d()).mo51515h(new C92028j(lVar), C60826bg.f164896a);
        if (this.f297874b.mo79746e(C90017bw.f247920ai)) {
            ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23411)).mo56386p("Sending chip. Only trigger media player.");
            cxVar = C60856cj.m92900i(Optional.m71637of(mo95716f(hVar)));
        } else {
            C106959m mVar = this.f297881k;
            C50671g gVar2 = (C50671g) C50672h.f131816d.createBuilder();
            if ((hVar.f297206a & 1) != 0) {
                C106531e a2 = C106531e.m177306a(hVar.f297207b);
                if (a2 == null) {
                    a2 = C106531e.UNKNOWN;
                }
                gVar2.copyOnWrite();
                C50672h hVar2 = (C50672h) gVar2.instance;
                hVar2.f131819b = a2.f297077e;
                hVar2.f131818a |= 1;
            }
            if ((hVar.f297206a & 128) != 0) {
                String str = hVar.f297213h;
                gVar2.copyOnWrite();
                C50672h hVar3 = (C50672h) gVar2.instance;
                str.getClass();
                hVar3.f131818a |= 2;
                hVar3.f131820c = str;
            }
            C50672h hVar4 = (C50672h) gVar2.build();
            if (mVar.f297920a.mo79746e(C90017bw.f247881W)) {
                cxVar2 = C60856cj.m92900i((C58485gu) Collection.EL.stream(mVar.f297920a.mo79745c(C90017bw.f247985bu)).map(C106953g.f297910a).collect(C58370cn.f155946a));
            } else if (mVar.f297927h) {
                cxVar2 = C60856cj.m92900i((C58485gu) Collection.EL.stream(mVar.f297924e.mo24218b(C18929i.RECENTLY_USED)).map(C106954h.f297911a).collect(C58370cn.f155946a));
            } else {
                boolean e = mVar.f297920a.mo79746e(C90017bw.f247902aQ);
                if (!e) {
                    cxVar4 = C60856cj.m92900i(C131090m.m213618c().mo110063a());
                } else {
                    cxVar4 = mVar.mo95721c(mVar.f297921b.mo95532b(hVar4), C131090m.m213618c().mo110063a(), "Failed to get on device media app suggestions");
                }
                C60870cx cxVar5 = cxVar4;
                C60870cx c = mVar.mo95721c(mVar.f297923d.mo76966b(), C58485gu.m89845m(), "Failed to get Habits profile media suggestions");
                C60870cx c2 = mVar.mo95721c(mVar.f297922c.mo95545a(), false, "Could not determine PR and WAA permissions");
                cxVar2 = C60856cj.m92895d(cxVar5, c, c2).mo57334a(new C106955i(mVar, cxVar5, c, c2, e), mVar.f297928i);
            }
            C47633f i = C47633f.m84733g(C47633f.m84733g(cxVar2).mo51515h(new C106940cu(this), this.f297882l).mo51513e(ExecutionException.class, new C106926cg(this), this.f297882l)).mo51516i(new C106932cm(this), this.f297882l);
            C106867ab abVar = this.f297885o;
            if (!abVar.f297761a.mo79746e(C90017bw.f248024cx)) {
                cxVar3 = C60856cj.m92900i(C123728av.f341753l);
            } else {
                cxVar3 = abVar.f297763c.mo19399b(new C106968v(abVar));
            }
            cxVar = C47636i.m84746e(i, cxVar3).mo51519b(new C106933cn(this, i, cxVar3, hVar), this.f297882l).mo51515h(new C106934co(this, hVar, empty), this.f297882l);
        }
        return C47636i.m84746e(h, cxVar).mo51519b(new C106935cp(this, h, hVar, cxVar), this.f297882l);
    }

    /* renamed from: d */
    public final boolean mo95699d() {
        return true;
    }

    /* renamed from: e */
    public final C50738bc mo95715e(C50706ar arVar, C106596h hVar) {
        ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23400)).mo56386p("#getChipCandidate(): start");
        this.f297884n.mo77192a(C118569b.SMARTSPACE_TRIGGER_HEADPHONE_COUNT, 1);
        String string = this.f297880j.getString(R.string.ama_media_only_chip);
        C106531e a = C106531e.m177306a(hVar.f297207b);
        if (a == null) {
            a = C106531e.UNKNOWN;
        }
        C107079a g = C107081c.m177812g();
        C50701am amVar = f297872i;
        g.mo95776b(amVar.f131953N);
        g.f298130a = Optional.m71637of(string);
        C107081c a2 = g.mo95775a();
        Context context = this.f297880j;
        Intent intent = new Intent();
        intent.setClassName(context, "com.google.android.apps.gsa.staticplugins.opa.ambient.activity.AmbientAssistantDetailsActivity");
        intent.addFlags(268468224);
        C107080b bVar = (C107080b) a2;
        if (bVar.f298134a.isPresent()) {
            C58976aa aaVar = C58975e.f156826a;
            intent.putExtra("EXTRA_MAIN_USE_CASE", (Serializable) bVar.f298134a.get());
        }
        if (bVar.f298135b.isPresent()) {
            C58976aa aaVar2 = C58975e.f156826a;
            intent.putExtra("EXTRA_TITLE", (String) bVar.f298135b.get());
        }
        if (bVar.f298136c.isPresent()) {
            C58976aa aaVar3 = C58975e.f156826a;
            intent.putExtra("EXTRA_DETAILS_PAGE_PAYLOAD", ((C50706ar) bVar.f298136c.get()).toByteArray());
        }
        C49156z c = this.f297883m.mo95750c(Optional.m71637of(Instant.ofEpochMilli(hVar.f297209d)), Duration.ofMillis(this.f297874b.mo79743a(C90017bw.f247940bB)));
        ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23401)).mo56389s("#getChipCandidate(): media chip's absolute time %s", c);
        C50702an a3 = this.f297883m.mo95749a(intent);
        a3.copyOnWrite();
        C50738bc bcVar = (C50738bc) a3.instance;
        C50738bc bcVar2 = C50738bc.f132032l;
        string.getClass();
        bcVar.f132034a |= 1;
        bcVar.f132037d = string;
        a3.copyOnWrite();
        C50738bc bcVar3 = (C50738bc) a3.instance;
        bcVar3.f132040g = amVar.f131953N;
        bcVar3.f132034a |= 8;
        a3.copyOnWrite();
        C50738bc bcVar4 = (C50738bc) a3.instance;
        bcVar4.f132034a |= 256;
        bcVar4.f132042i = true;
        String h = m177658h(hVar);
        a3.copyOnWrite();
        C50738bc bcVar5 = (C50738bc) a3.instance;
        h.getClass();
        bcVar5.f132034a |= 2;
        bcVar5.f132038e = h;
        a3.copyOnWrite();
        C50738bc bcVar6 = (C50738bc) a3.instance;
        c.getClass();
        bcVar6.f132041h = c;
        bcVar6.f132034a |= 16;
        C50710av b = C107060a.m177773b(a == C106531e.GENERIC_BLUETOOTH ? "https://fonts.gstatic.com/s/i/googlematerialicons/bluetooth_audio/v6/white-24dp/2x/gm_bluetooth_audio_white_24dp.png" : "https://fonts.gstatic.com/s/i/googlematerialicons/headphones/v4/white-24dp/1x/gm_headphones_white_24dp.png");
        a3.copyOnWrite();
        C50738bc bcVar7 = (C50738bc) a3.instance;
        b.getClass();
        bcVar7.f132039f = b;
        bcVar7.f132034a |= 4;
        if (this.f297874b.mo79746e(C90017bw.f247969be)) {
            a3.copyOnWrite();
            C50738bc bcVar8 = (C50738bc) a3.instance;
            arVar.getClass();
            bcVar8.f132044k = arVar;
            bcVar8.f132034a |= 512;
        }
        C50738bc bcVar9 = (C50738bc) a3.build();
        ((C58970a) ((C58970a) this.f297873a.mo56224b()).mo56372aa(23402)).mo56386p("Sending chip. Trigger both media player and recommendations.");
        return bcVar9;
    }

    /* renamed from: f */
    public final C50738bc mo95716f(C106596h hVar) {
        C50705aq aqVar = (C50705aq) C50706ar.f131960a.createBuilder();
        C62940bt btVar = C50693ae.f131889h;
        C50692ad adVar = (C50692ad) C50693ae.f131888g.createBuilder();
        long j = hVar.f297209d;
        adVar.copyOnWrite();
        C50693ae aeVar = (C50693ae) adVar.instance;
        aeVar.f131891a |= 2;
        aeVar.f131893c = j;
        C106595g a = C106595g.m177369a(hVar.f297218m);
        if (a == null) {
            a = C106595g.UNSPECIFIED;
        }
        adVar.copyOnWrite();
        C50693ae aeVar2 = (C50693ae) adVar.instance;
        aeVar2.f131894d = a.f297203i;
        aeVar2.f131891a |= 4;
        long a2 = this.f297874b.mo79743a(C90017bw.f248010cj);
        adVar.copyOnWrite();
        C50693ae aeVar3 = (C50693ae) adVar.instance;
        aeVar3.f131891a |= 8;
        aeVar3.f131895e = a2;
        aqVar.mo58885m(btVar, (C50693ae) adVar.build());
        return mo95715e((C50706ar) aqVar.build(), hVar);
    }

    /* renamed from: g */
    public final C60870cx mo95717g(Optional optional) {
        if (!optional.isPresent()) {
            return C60856cj.m92900i(C107017f.m177726d().mo95685a());
        }
        if (!this.f297874b.mo79746e(C90017bw.f247890aE)) {
            return C60856cj.m92900i(C107017f.m177727e((C50738bc) optional.get()));
        }
        C106924ce ceVar = this.f297886p;
        C50738bc bcVar = (C50738bc) optional.get();
        return C47633f.m84733g(C47633f.m84733g(ceVar.f297842a.mo77189a(bcVar)).mo51516i(new C106921cb(ceVar), ceVar.f297845d).mo51515h(new C106922cc(bcVar), ceVar.f297845d).mo51513e(IllegalStateException.class, new C106923cd(ceVar), ceVar.f297845d)).mo51515h(new C106925cf(this), this.f297882l);
    }
}
